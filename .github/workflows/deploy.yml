# Deploy to Cloudflare Pages (.com) + Aliyun OSS (.cn mirror)
# Only GitHub Actions builds and deploys; no Cloudflare Git integration.
name: Deploy to Cloudflare and Aliyun

on:
  push:
    branches: [release_v3.0]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Astro
        run: npm run build

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_PAGES_PROJECT_NAME: ${{ secrets.CF_PAGES_PROJECT_NAME }}
        run: |
          npm install -g wrangler
          wrangler pages deploy dist --project-name="$CF_PAGES_PROJECT_NAME"

      - name: Install ossutil
        run: |
          curl -o ossutil64 "https://gosspublic.alicdn.com/ossutil/1.7.18/ossutil64"
          chmod +x ossutil64
          sudo mv ossutil64 /usr/local/bin/ossutil

      - name: Configure ossutil
        env:
          ALIYUN_ACCESS_KEY_ID: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          ALIYUN_ACCESS_KEY_SECRET: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          ALIYUN_OSS_REGION: ${{ secrets.ALIYUN_OSS_REGION }}
        run: |
          ossutil config \
            -e oss-$ALIYUN_OSS_REGION.aliyuncs.com \
            -i "$ALIYUN_ACCESS_KEY_ID" \
            -k "$ALIYUN_ACCESS_KEY_SECRET" \
            -L EN

      - name: Upload dist to Aliyun OSS
        env:
          ALIYUN_OSS_BUCKET: ${{ secrets.ALIYUN_OSS_BUCKET }}
        run: ossutil cp -r dist/ "oss://$ALIYUN_OSS_BUCKET/" --update
